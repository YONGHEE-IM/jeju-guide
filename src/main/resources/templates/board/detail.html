<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">게시글</title>
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <link rel="stylesheet" th:href="@{/css/board.css}">
</head>
<body>
<div class="container board-show">
  <a class="back" th:href="@{/boards}">← 목록으로</a>

  <article class="post card">
    <h1 class="title" th:text="${post.title}">제목</h1>

    <div class="meta">
      <span th:text="${post.authorName}">작성자</span>
      <span class="dot">·</span>
      <span th:text="${#temporals.format(post.createdAt, 'yyyy년 M월 d일 a h:mm')}">날짜</span>
    </div>

    <!-- 액션: 수정/삭제 (문자열 따옴표 수정) -->
    <div class="actions" sec:authorize="isAuthenticated()"
	     th:if="${#authentication.name == post.authorEmail or #authorization.expression('hasRole(''ADMIN'')')}"
	     style="margin-top:10px; display:flex; gap:8px;">
	  <a th:href="@{|/boards/${post.id}/edit|}" class="btn-primary">수정</a>
	
	  <form th:action="@{|/boards/${post.id}/delete|}" method="post" style="display:inline;">
	    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
	    <button type="submit" class="btn-primary">삭제</button>
	  </form>
	</div>

    <div class="chips">
      <span class="chip"><span class="i">👁</span><span th:text="${post.viewCount}">0</span></span>
      <span class="chip"><span class="i">💬</span><span th:text="${#lists.size(post.comments)}">0</span></span>
    </div>

    <div class="content" th:utext="${#strings.replace(post.content, '\n', '<br>')}">본문</div>   
  </article>

  <section class="comments card">
    <h3 class="c-title" th:text="'댓글 ' + ${#lists.size(post.comments)} + '개'">댓글 0개</h3>

    <form class="c-form" th:action="@{|/boards/${post.id}/comments|}" method="post" sec:authorize="isAuthenticated()">
      <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <textarea name="content" class="input-area" rows="3" placeholder="댓글을 입력하세요"></textarea>
      <button type="submit" class="btn-primary">댓글 작성</button>
    </form>
    <p class="muted" sec:authorize="!isAuthenticated()">로그인 후 댓글 작성이 가능합니다.</p>

    <div class="c-list">
      <div class="c-item" th:each="c : ${post.comments}">
  <div class="c-meta">
    <strong th:text="${c.authorName}">작성자</strong>
    <span class="dot">·</span>
    <span th:text="${#temporals.format(c.createdAt, 'yyyy. M. d. a h:mm')}">시간</span>
  </div>

  <div class="c-body" th:text="${c.content}">내용</div>

  <!-- 내 댓글이면: 수정/삭제 버튼 -->
  <div class="c-actions"
       th:if="${#authentication.name == c.authorEmail or #authorization.expression('hasRole(''ADMIN'')')}"
       style="margin-top:6px; display:flex; gap:8px;">

    <form th:action="@{|/boards/${post.id}/comments/${c.id}/delete|}" method="post" style="display:inline;">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <button type="submit" class="btn-primary">삭제</button>
    </form>
  </div>

  <!-- 인라인 수정 폼 (토글) -->
  <div class="c-edit" th:id="${'edit-'+c.id}" style="display:none; margin-top:8px;">
    <form th:action="@{|/boards/${post.id}/comments/${c.id}/edit|}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <textarea name="content" class="input-area" rows="2" th:text="${c.content}"></textarea>
      <div style="margin-top:6px; display:flex; gap:8px;">
        <button type="submit" class="btn-primary">저장</button>
        <button type="button" class="btn-light" onclick="this.closest('.c-edit').style.display='none'">취소</button>
      </div>
    </form>
  </div>
</div>
</div>

  </section>
</div>
</body>
</html>
